<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>虚拟宠物系统 - 标准化版本测试</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #2b2b2b;
            color: #fff;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #3b3b3b;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #4b4b4b;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .side-by-side {
            display: flex;
            gap: 20px;
        }
        .side-by-side > div {
            flex: 1;
        }
        #extensions_settings2 {
            background: #2b2b2b;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #444;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🐾 虚拟宠物系统 - 标准化版本测试</h1>
        
        <div class="test-section">
            <h2>1. SillyTavern环境模拟</h2>
            <p>模拟SillyTavern的标准扩展环境，包括extension_settings、getContext等API。</p>
            <button onclick="setupSillyTavernEnvironment()">🎭 设置SillyTavern环境</button>
            <button onclick="clearEnvironment()">🧹 清除环境</button>
            <div id="env-log" class="log" style="max-height: 150px;"></div>
        </div>

        <div class="side-by-side">
            <div class="test-section">
                <h2>2. 扩展功能测试</h2>
                <button onclick="testExtensionLoading()">📦 测试扩展加载</button>
                <button onclick="testSettingsManagement()">⚙️ 测试设置管理</button>
                <button onclick="testApiIntrospection()">🕵️ 测试API内省</button>
                <button onclick="testPetButton()">🐾 测试宠物按钮</button>
                <button onclick="runFullTest()">🔍 完整测试</button>
                <div id="test-log" class="log"></div>
            </div>

            <div class="test-section">
                <h2>3. 设置面板预览</h2>
                <p>这里显示实际的设置面板：</p>
                <div id="extensions_settings2"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>4. 实时状态监控</h2>
            <button onclick="startStatusMonitoring()">📊 开始监控</button>
            <button onclick="stopStatusMonitoring()">⏹️ 停止监控</button>
            <div id="status-log" class="log" style="max-height: 200px;"></div>
        </div>
    </div>

    <!-- 模拟SillyTavern的全局对象 -->
    <script>
        // 模拟SillyTavern的extension_settings
        window.extension_settings = {};
        
        // 模拟getContext函数
        window.getContext = function() {
            return {
                api_server: '/api/v1/generate',
                chat: [],
                characters: [],
                characterId: 0,
                groups: [],
                extensionSettings: window.extension_settings,
                saveSettingsDebounced: function() {
                    console.log('Settings saved (debounced)');
                    envLog('💾 设置已保存 (防抖)', 'success');
                }
            };
        };
        
        // 模拟saveSettingsDebounced
        window.saveSettingsDebounced = function() {
            console.log('Settings saved (debounced)');
            envLog('💾 设置已保存 (防抖)', 'success');
        };

        let statusMonitoringInterval = null;

        function envLog(message, type = 'info') {
            const logDiv = document.getElementById('env-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function testLog(message, type = 'info') {
            const logDiv = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function statusLog(message) {
            const logDiv = document.getElementById('status-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setupSillyTavernEnvironment() {
            // 模拟更多SillyTavern对象
            window.SillyTavern = {
                settings: {
                    api_endpoint: '/api/v1/generate',
                    generation_settings: {
                        endpoint: '/api/generate'
                    }
                },
                config: {
                    api_url: '/completions'
                },
                generateReply: async function(prompt) {
                    return `模拟AI回复: ${prompt.substring(0, 50)}...`;
                }
            };

            window.st = {
                api: {
                    endpoint: '/api/st/generate'
                }
            };

            // 模拟toastr（如果不存在）
            if (typeof toastr === 'undefined') {
                window.toastr = {
                    success: (msg) => envLog(`✅ ${msg}`, 'success'),
                    info: (msg) => envLog(`ℹ️ ${msg}`, 'info'),
                    warning: (msg) => envLog(`⚠️ ${msg}`, 'warning'),
                    error: (msg) => envLog(`❌ ${msg}`, 'error')
                };
            }

            envLog('✅ SillyTavern环境已设置', 'success');
            envLog('- window.extension_settings 已初始化', 'info');
            envLog('- window.getContext() 可用', 'info');
            envLog('- window.SillyTavern 对象已创建', 'info');
            envLog('- 模拟API端点已配置', 'info');
        }

        function clearEnvironment() {
            delete window.SillyTavern;
            delete window.st;
            window.extension_settings = {};
            envLog('🧹 环境已清除', 'warning');
        }

        function testExtensionLoading() {
            testLog('📦 开始测试扩展加载...', 'info');
            
            try {
                // 检查是否有必要的全局函数
                if (typeof getContext === 'function') {
                    testLog('✅ getContext() 函数可用', 'success');
                } else {
                    testLog('❌ getContext() 函数不可用', 'error');
                }

                if (typeof saveSettingsDebounced === 'function') {
                    testLog('✅ saveSettingsDebounced() 函数可用', 'success');
                } else {
                    testLog('❌ saveSettingsDebounced() 函数不可用', 'error');
                }

                if (typeof extension_settings === 'object') {
                    testLog('✅ extension_settings 对象可用', 'success');
                } else {
                    testLog('❌ extension_settings 对象不可用', 'error');
                }

                testLog('📦 扩展加载测试完成', 'success');
            } catch (error) {
                testLog(`❌ 扩展加载测试失败: ${error.message}`, 'error');
            }
        }

        function testSettingsManagement() {
            testLog('⚙️ 开始测试设置管理...', 'info');
            
            try {
                // 模拟设置操作
                const testSettings = {
                    enabled: true,
                    personalityType: 'cheerful',
                    apiEndpoint: 'auto'
                };

                extension_settings['virtual-pet-system'] = testSettings;
                testLog('✅ 设置写入成功', 'success');

                const readSettings = extension_settings['virtual-pet-system'];
                if (readSettings && readSettings.enabled === true) {
                    testLog('✅ 设置读取成功', 'success');
                } else {
                    testLog('❌ 设置读取失败', 'error');
                }

                testLog('⚙️ 设置管理测试完成', 'success');
            } catch (error) {
                testLog(`❌ 设置管理测试失败: ${error.message}`, 'error');
            }
        }

        function testApiIntrospection() {
            testLog('🕵️ 开始测试API内省...', 'info');
            
            try {
                // 检查是否能找到API配置
                const candidates = ['SillyTavern', 'st', 'config'];
                let found = false;

                for (const candidate of candidates) {
                    if (window[candidate]) {
                        testLog(`✅ 找到全局对象: window.${candidate}`, 'success');
                        found = true;
                    }
                }

                if (!found) {
                    testLog('⚠️ 未找到API配置对象', 'warning');
                }

                testLog('🕵️ API内省测试完成', 'success');
            } catch (error) {
                testLog(`❌ API内省测试失败: ${error.message}`, 'error');
            }
        }

        function testPetButton() {
            testLog('🐾 开始测试宠物按钮...', 'info');
            
            try {
                // 检查是否能创建按钮
                const testButton = $('<div id="test-pet-button" style="position: fixed; top: 100px; left: 100px; width: 48px; height: 48px; background: #FF9EC7; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 999999;">🐾</div>');
                $('body').append(testButton);
                
                testLog('✅ 测试按钮创建成功', 'success');
                
                // 3秒后移除测试按钮
                setTimeout(() => {
                    testButton.remove();
                    testLog('🧹 测试按钮已移除', 'info');
                }, 3000);

                testLog('🐾 宠物按钮测试完成', 'success');
            } catch (error) {
                testLog(`❌ 宠物按钮测试失败: ${error.message}`, 'error');
            }
        }

        function runFullTest() {
            testLog('🔍 开始完整测试...', 'info');
            testLog('='.repeat(50), 'info');
            
            testExtensionLoading();
            setTimeout(() => testSettingsManagement(), 500);
            setTimeout(() => testApiIntrospection(), 1000);
            setTimeout(() => testPetButton(), 1500);
            setTimeout(() => {
                testLog('='.repeat(50), 'info');
                testLog('🔍 完整测试完成', 'success');
            }, 2000);
        }

        function startStatusMonitoring() {
            if (statusMonitoringInterval) return;
            
            statusLog('📊 开始状态监控...');
            
            statusMonitoringInterval = setInterval(() => {
                const stats = {
                    扩展设置数量: Object.keys(extension_settings).length,
                    jQuery版本: $.fn.jquery || 'N/A',
                    当前时间: new Date().toLocaleTimeString(),
                    内存使用: performance.memory ? `${Math.round(performance.memory.usedJSHeapSize / 1024 / 1024)}MB` : 'N/A'
                };
                
                statusLog(`状态: ${JSON.stringify(stats, null, 2)}`);
            }, 3000);
        }

        function stopStatusMonitoring() {
            if (statusMonitoringInterval) {
                clearInterval(statusMonitoringInterval);
                statusMonitoringInterval = null;
                statusLog('⏹️ 状态监控已停止');
            }
        }

        // 页面加载完成后自动设置环境
        $(document).ready(function() {
            setupSillyTavernEnvironment();
            testLog('🚀 测试页面加载完成', 'success');
            testLog('可以开始测试标准化的虚拟宠物扩展', 'info');
        });
    </script>

    <!-- 加载新的标准化扩展 -->
    <script type="module" src="index-new.js"></script>
</body>
</html>
